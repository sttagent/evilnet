---
- name: create grocy pod
  become_user: "{{ container_user }}"
  containers.podman.podman_pod:
    name: "{{ pod_name }}"
    state: created
    ports:
      - "{{ host_port }}:{{ pod_port }}"
    label:
      io.containers.autoupdate: registry
    generate_systemd:
      names: true
      new: true
      separator: "_"
      path: "/home/{{ container_user }}/.config/systemd/user"

- name: create gorcy backend container
  become_user: "{{ container_user }}"
  containers.podman.podman_container:
    name: "{{ backend_name }}"
    image: "{{ backend_image }}:{{ backend_version }}"
    pod: "{{ pod_name }}"
    state: created
    detach: true
    tty: true
    env:
      GROCY_MODE: production
      GROCY_CULTURE: sv_SE
      GROCY_CURRENCY: SEK
    volumes:
      - "/home/{{ container_user }}/Containers/data/grocy/data/:/var/www/data/:Z,U"
    label:
      io.containers.autoupdate: registry
    generate_systemd:
      names: true
      new: true
      separator: "_"
      path: "/home/{{ container_user }}/.config/systemd/user"
      requires: "pod_{{ pod_name }}"

- name: create grocy frontend container
  become_user: "{{ container_user }}"
  containers.podman.podman_container:
    name: "{{ frontend_name }}"
    image: "{{ frontend_image }}:{{ frontend_version }}"
    pod: "{{ pod_name }}"
    state: created
    detach: true
    tty: true
    label:
      io.containers.autoupdate: registry
    generate_systemd:
      names: true
      new: true
      separator: "_"
      path: "/home/{{ container_user }}/.config/systemd/user"
      requires: "pod_{{ pod_name }}"

- name: start grocy pod service
  become_user: "{{ container_user }}"
  systemd:
    scope: user
    name: "pod_{{ pod_name }}"
    state: started
    enabled: true
    daemon_reload: true

- name: start grocy backend service
  become_user: "{{ container_user }}"
  systemd:
    scope: user
    name: "container_{{ backend_name }}"
    state: started
    enabled: true
    daemon_reload: true

- name: start grocy frontend service
  become_user: "{{ container_user }}"
  systemd:
    scope: user
    name: "container_{{ frontend_name }}"
    state: started
    enabled: true
    daemon_reload: true

