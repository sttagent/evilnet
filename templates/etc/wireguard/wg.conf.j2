#jinja2: lstrip_blocks:"True",trim_blocks:"True"
# {{ ansible_managed }}

[Interface]
# {{ inventory_hostname }}
Address = {{ wireguard_address }}
PrivateKey = {{ wireguard_private_key }}
{% if wireguard_port is defined %}
ListenPort = {{ wireguard_port }}
{% endif %}
{% if wireguard_dns is defined %}
DNS = {{ wireguard_dns }}
{% endif %}
{% if wireguard_preup is defined %}
{% for wg_preup in wireguard_preup %}
PreUp = {{ wg_preup }}
{% endfor %}
{% endif %}  
{% if wireguard_predown is defined %}
{% for wg_predown in wireguard_predown %}
PreDown = {{ wg_predown }}
{% endfor %}
{% endif %}  
{% if wireguard_postup is defined %}
{% for wg_postup in wireguard_postup %}
PostUp = {{ wg_postup }}
{% endfor %}
{% endif %}  
{% if wireguard_postdown is defined %}
{% for wg_postdown in wireguard_postdown %}
PostDowon = {{ wg_postdown }}
{% endfor %}
{% endif %}  
{% if wireguard_save_config is defined %}
SaveConfig = true
{% endif %}
{% for host in ansible_play_hosts %}
{%      if host != inventory_hostname %}

[Peer]
# {{ host }}
PublicKey = {{ hostvars[host].wireguard_public_key }}
{%          if hostvars[host].wireguard_allowed_ips is defined %}
AllowedIPs = {{ hostvars[host].wireguard_allowed_ips }}
{%          else %}
AllowedIPs = {{ hostvars[host].wireguard_address }}
{%          endif %}
{%          if hostvars[host].wireguard_persitent_keepalive is defined %}
PersistentKeepalive = {{ hostvars[host].wireguard_persistent_keepalive }}
{%          endif %}
{%          if hostvars[host].wireguard_endpoint is defined and hostvars[host].wireguard_port is defined%}
Endpoint = {{ hostvars[host].wireguard_endpoint }}:{{ hostvars[host].wireguard_port }}
{%          endif %}
{%      endif %}
{% endfor %}
{% if wireguard_unmanaged_peers is defined %}
{%      for peer in wireguard_unmanaged_peers.keys() %}

[Peer]
# {{ peer }}
PublicKey = {{ wireguard_unmanaged_peers[peer].public_key }}
AllowedIPs = {{ wireguard_unmanaged_peers[peer].allowed_ips }}
{%      endfor %}
{% endif %}